<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="&lt;h6 id=&quot;特点&quot;&gt;&lt;a href=&quot;#特点&quot; class=&quot;headerlink&quot; title=&quot;特点:&quot;&gt;&lt;/a&gt;特点:&lt;/h6&gt;&lt;ul&gt;
&lt;li&gt;服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息&lt;/li&gt;
&lt;li&gt;建立在 TCP 协议之上，服务器端的实现比较容易。&lt;/li&gt;
&lt;li&gt;与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。&lt;/li&gt;
&lt;li&gt;数据格式比较轻量，性能开销小，通信高效。&lt;/li&gt;
&lt;li&gt;可以发送文本，也可以发送二进制数据。&lt;/li&gt;
&lt;li&gt;没有同源限制，客户端可以与任意服务器通信。&lt;/li&gt;
&lt;li&gt;协议标识符是ws（如果加密，则为wss），服务器网址就是 URL。&lt;/li&gt;
&lt;/ul&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>WebSocket | 柠檬小小</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><header class="wrapper header"><div class="container blog-title"><a class="title" id="logo" href="/.">柠檬小小</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div><input id="menu" type="checkbox"><div class="container nav-items"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></div></header><article class="wrapper"><div class="post-entry"><div class="post"><div class="container post-header"><h1>WebSocket</h1></div><div class="container post-content"><h6 id="特点"><a href="#特点" class="headerlink" title="特点:"></a>特点:</h6><ul>
<li>服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息</li>
<li>建立在 TCP 协议之上，服务器端的实现比较容易。</li>
<li>与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。</li>
<li>数据格式比较轻量，性能开销小，通信高效。</li>
<li>可以发送文本，也可以发送二进制数据。</li>
<li>没有同源限制，客户端可以与任意服务器通信。</li>
<li>协议标识符是ws（如果加密，则为wss），服务器网址就是 URL。</li>
</ul>
<a id="more"></a>
<h6 id="代码实现："><a href="#代码实现：" class="headerlink" title="代码实现："></a>代码实现：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">data() &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    websock:null,</span><br><span class="line">    lockReconnect: false, //是否真正建立链接</span><br><span class="line">    timeout: 300000, //30秒一次心跳</span><br><span class="line">    timeoutObj: null, //心跳倒计时</span><br><span class="line">    serverTimeoutObj: null, //心跳倒计时</span><br><span class="line">    timeoutnum: null, //断开重连倒计时</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">methods: &#123;</span><br><span class="line">  //初始化WebSocket</span><br><span class="line">  initWebSocket()&#123;</span><br><span class="line">    var wsurl = &quot;wss://&quot;+location.host+&quot;……&quot;</span><br><span class="line">    if(location.host===&apos;localhost:8080&apos;) &#123;</span><br><span class="line">      wsurl = &quot;ws://&quot;+location.host+&quot;……&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    this.websock = new WebSocket(wsurl)</span><br><span class="line">    this.websock.onopen = this.webscoketonopen</span><br><span class="line">    this.websock.onerror = this.webscoketonerror</span><br><span class="line">    this.websock.onmessage = this.webscoketonmessage</span><br><span class="line">    this.websock.onclose = this.webscoketonclose</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  webscoketonopen() &#123;</span><br><span class="line">    console.log(&apos;链接成功&apos;)</span><br><span class="line">    //开启心跳</span><br><span class="line">    this.startHearthBeat()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  webscoketonerror() &#123;</span><br><span class="line">    console.log(&apos;链接失败&apos;)</span><br><span class="line">    //重连</span><br><span class="line">    this.reconnect()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  webscoketonmessage(e) &#123;</span><br><span class="line">    if(e.data === &apos;链接成功&apos; || e.data === &apos;ping&apos;) &#123;</span><br><span class="line">      console.log(e)</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">      …………</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  webscoketonclose(e) &#123;</span><br><span class="line">    console.log(&quot;断开链接&quot;)</span><br><span class="line">    this.reconnect()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  startHearthBeat() &#123;</span><br><span class="line">    this.timeoutObj &amp;&amp; clearTimeout(this.timeoutObj)</span><br><span class="line">    this.serverTimeoutObj &amp;&amp; clearTimeout(this.serverTimeoutObj)</span><br><span class="line">    this.timeoutObj = setTimeout(function() &#123;</span><br><span class="line">      //这里发送一个心跳，后端收到，返回一个心跳信息</span><br><span class="line">      console.log(this.websock.readyState)</span><br><span class="line">      if(this.websock.readyState === 1) &#123;</span><br><span class="line">        //链接正常</span><br><span class="line">        this.websock.send(&apos;ping&apos;)        </span><br><span class="line">      &#125;else &#123;</span><br><span class="line">        //否则重链</span><br><span class="line">        this.reconnect()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      this.serverTimeoutObj = setTimeout(function() &#123;</span><br><span class="line">        console.log(&apos;超时关闭&apos;)</span><br><span class="line">        &#125;,this.timeout)</span><br><span class="line"></span><br><span class="line">      &#125;, this.timeout)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  reconnect() &#123;</span><br><span class="line">    if(this.lockReconnect) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    this.lockReconnect = true</span><br><span class="line">    this.timeoutnum &amp;&amp; clearTimeout(this.timeoutnum)</span><br><span class="line">    this.timeoutnum = setTimeout(function() &#123;</span><br><span class="line">      this.initWebSocket()</span><br><span class="line">      this.lockReconnect = false</span><br><span class="line">      &#125;,5000)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="心跳重连缘由"><a href="#心跳重连缘由" class="headerlink" title="心跳重连缘由"></a>心跳重连缘由</h6><p>在使用websocket过程中，可能会出现网络断开的情况，比如信号不好，或者网络临时性关闭，这时候websocket的连接已经断开，<br>而浏览器不会执行websocket 的 onclose方法，我们无法知道是否断开连接，也就无法进行重连操作。<br>如果当前发送websocket数据到后端，一旦请求超时，onclose便会执行，这时候便可进行绑定好的重连操作。<br>因此websocket心跳重连就应运而生。</p>
</div></div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>